<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>KinKonnect ‚Äì Classmates Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #0f172a;
      color: #e5e7eb;
    }

    body {
      margin: 0;
      padding: 0;
      background: #0f172a;
      color: #e5e7eb;
    }

    .app {
      max-width: 1100px;
      margin: 0 auto;
      padding: 1.5rem 1.25rem 2.5rem;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
    }

    .title {
      display: flex;
      flex-direction: column;
      gap: 0.3rem;
    }

    .subtitle {
      font-size: 0.9rem;
      color: #9ca3af;
    }

    .pill {
      padding: 0.15rem 0.6rem;
      border-radius: 999px;
      background: rgba(34,197,94,0.12);
      color: #22c55e;
      font-size: 0.75rem;
      border: 1px solid rgba(34,197,94,0.4);
    }

    .layout {
      display: grid;
      grid-template-columns: minmax(0, 1.3fr) minmax(0, 1.5fr);
      gap: 1.25rem;
    }

    @media (max-width: 900px) {
      .layout {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background: #020617;
      border-radius: 0.9rem;
      padding: 1rem 1.1rem;
      box-shadow: 0 18px 35px rgba(15,23,42,0.75);
      border: 1px solid #1f2937;
      box-sizing: border-box;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.75rem;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .card-title {
      font-size: 1rem;
      font-weight: 600;
      color: #e5e7eb;
    }

    .card-sub {
      font-size: 0.8rem;
      color: #9ca3af;
    }

    label {
      display: block;
      font-size: 0.8rem;
      margin-bottom: 0.18rem;
      color: #d1d5db;
    }

    input[type="text"],
    input[type="tel"],
    select,
    textarea {
      width: 100%;
      box-sizing: border-box;
      padding: 0.45rem 0.55rem;
      border-radius: 0.55rem;
      border: 1px solid #1f2937;
      background: #020617;
      color: #e5e7eb;
      font-size: 0.85rem;
      outline: none;
      transition: border 0.15s, box-shadow 0.15s, background 0.15s;
    }

    input:focus,
    select:focus,
    textarea:focus {
      border-color: #6366f1;
      box-shadow: 0 0 0 1px #6366f1;
      background: #020617;
    }

    textarea {
      resize: vertical;
      min-height: 60px;
    }

    .field-row {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 0.6rem;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.3rem;
      padding: 0.45rem 0.95rem;
      border-radius: 999px;
      font-size: 0.85rem;
      border: none;
      cursor: pointer;
      background: #6366f1;
      color: #e5e7eb;
      font-weight: 500;
      transition: transform 0.1s, box-shadow 0.1s, background 0.1s;
      white-space: nowrap;
    }

    .btn:hover {
      background: #4f46e5;
      box-shadow: 0 12px 25px rgba(79,70,229,0.6);
      transform: translateY(-1px);
    }

    .btn.secondary {
      background: #111827;
      border: 1px solid #374151;
      box-shadow: none;
    }

    .btn.secondary:hover {
      background: #020617;
      box-shadow: none;
      transform: none;
    }

    .btn.small {
      padding: 0.25rem 0.6rem;
      font-size: 0.8rem;
    }

    .controls-top {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
      flex-wrap: wrap;
    }

    .search {
      flex: 1;
      min-width: 140px;
    }

    .badge {
      font-size: 0.75rem;
      color: #9ca3af;
    }

    .list {
      max-height: 340px;
      overflow: auto;
      padding-right: 0.2rem;
      margin-top: 0.5rem;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .classmate {
      padding: 0.5rem 0.55rem;
      border-radius: 0.6rem;
      background: #020617;
      border: 1px solid #1f2937;
      font-size: 0.82rem;
    }

    .classmate.nearby {
      border-color: #facc15;
      box-shadow: 0 0 0 1px #facc15;
    }

    .classmate-header {
      display: flex;
      justify-content: space-between;
      gap: 0.4rem;
      align-items: center;
      margin-bottom: 0.1rem;
    }

    .classmate-name {
      font-weight: 600;
      color: #e5e7eb;
    }

    .classmate-town {
      font-size: 0.75rem;
      color: #9ca3af;
    }

    .classmate-phone {
      font-size: 0.8rem;
      color: #a5b4fc;
    }

    .classmate-detail {
      font-size: 0.78rem;
      color: #cbd5f5;
      margin-top: 0.15rem;
    }

    .empty {
      font-size: 0.82rem;
      color: #6b7280;
      text-align: center;
      padding: 0.8rem 0.4rem;
    }

    .map-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 0.55rem;
      margin-top: 0.75rem;
    }

    .town-tile {
      border-radius: 0.7rem;
      padding: 0.55rem 0.6rem;
      background: #020617;
      border: 1px solid #1f2937;
      font-size: 0.8rem;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      gap: 0.12rem;
      transition: transform 0.12s, box-shadow 0.12s, border 0.12s, background 0.12s;
    }

    .town-tile span {
      pointer-events: none;
    }

    .town-name {
      font-weight: 600;
      color: #e5e7eb;
    }

    .town-count {
      font-size: 0.78rem;
      color: #9ca3af;
    }

    .town-tile.has-people {
      background: linear-gradient(135deg, #022c22, #064e3b);
      border-color: #22c55e;
      box-shadow: 0 10px 25px rgba(34,197,94,0.5);
    }

    .town-tile.nearby-town {
      background: linear-gradient(135deg, #451a03, #78350f);
      border-color: #facc15;
      box-shadow: 0 10px 25px rgba(250,204,21,0.5);
    }

    .town-tile.selected {
      outline: 1px solid #e5e7eb;
    }

    .map-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .map-status {
      font-size: 0.8rem;
      color: #9ca3af;
    }

    .danger-link {
      font-size: 0.75rem;
      color: #fca5a5;
      text-decoration: underline;
      cursor: pointer;
    }

    .footer-note {
      margin-top: 0.55rem;
      font-size: 0.75rem;
      color: #6b7280;
    }

    .about-list {
      font-size: 0.85rem;
      color: #d1d5db;
      padding-left: 1.1rem;
      margin: 0.35rem 0 0.6rem;
    }

    .about-list li {
      margin-bottom: 0.2rem;
    }

    .small-muted {
      font-size: 0.75rem;
      color: #9ca3af;
    }

    /* LIGHT THEME OVERRIDES */
    body.theme-light {
      background: #f3f4f6;
      color: #111827;
    }

    body.theme-light .card {
      background: #ffffff;
      border-color: #e5e7eb;
      box-shadow: 0 10px 25px rgba(148,163,184,0.35);
    }

    body.theme-light input[type="text"],
    body.theme-light input[type="tel"],
    body.theme-light select,
    body.theme-light textarea {
      background: #ffffff;
      border-color: #d1d5db;
      color: #111827;
    }

    body.theme-light input[type="text"]:focus,
    body.theme-light input[type="tel"]:focus,
    body.theme-light select:focus,
    body.theme-light textarea:focus {
      background: #ffffff;
    }

    body.theme-light .classmate {
      background: #ffffff;
      border-color: #e5e7eb;
    }

    body.theme-light .classmate.nearby {
      border-color: #eab308;
      box-shadow: 0 0 0 1px #eab308;
    }

    body.theme-light .town-tile {
      background: #ffffff;
      border-color: #e5e7eb;
    }

    body.theme-light .town-tile.has-people {
      background: linear-gradient(135deg, #dcfce7, #bbf7d0);
      border-color: #16a34a;
      box-shadow: 0 10px 25px rgba(74,222,128,0.6);
    }

    body.theme-light .town-tile.nearby-town {
      background: linear-gradient(135deg, #fef3c7, #fde68a);
      border-color: #eab308;
      box-shadow: 0 10px 25px rgba(250,204,21,0.6);
    }

    body.theme-light .card-title {
      color: #111827;
    }

    body.theme-light .subtitle {
      color: #4b5563;
    }

    body.theme-light .badge {
      color: #6b7280;
    }

    body.theme-light .small-muted {
      color: #6b7280;
    }

    body.theme-light .btn.secondary {
      background: #f9fafb;
      border-color: #d1d5db;
      color: #111827;
    }

    body.theme-light .btn.secondary:hover {
      background: #e5e7eb;
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="title">
        <!-- Logo (3 dots + KinKonnect) -->
        <svg width="200" height="50" viewBox="0 0 200 50" xmlns="http://www.w3.org/2000/svg">
          <circle cx="40" cy="10" r="3" fill="#22c55e"/>
          <circle cx="55" cy="10" r="3" fill="#6366f1"/>
          <circle cx="70" cy="10" r="3" fill="#facc15"/>
          <text x="20" y="32" font-size="22" font-family="system-ui, sans-serif" fill="#e5e7eb" font-weight="600">
            KinKonnect
          </text>
          <text x="22" y="44" font-size="10" font-family="system-ui, sans-serif" fill="#9ca3af">
            Stay linked after school
          </text>
        </svg>

        <div class="subtitle">
          See where your classmates are across Kenya üåç ‚Äì and who is near who.
        </div>
      </div>
      <div style="display:flex; gap:0.5rem; align-items:center; flex-wrap:wrap;">
        <button id="themeToggle" class="btn small secondary" type="button">
          Light mode
        </button>
        <span class="pill">High school class of 100</span>
      </div>
    </header>

    <div class="layout">
      <!-- LEFT: form + list -->
      <section class="card">
        <div class="card-header">
          <div>
            <div class="card-title">Add / edit classmate</div>
            <div class="card-sub">
              Store name, phone, town and specific place. Add GPS to detect who's close.
            </div>
          </div>
          <div style="display:flex; gap:0.35rem; flex-wrap:wrap;">
            <input type="file" id="importFile" accept="application/json" style="display:none;" />
            <button id="importBtn" class="btn small secondary" type="button">
              Import
            </button>
            <button id="exportBtn" class="btn small secondary" type="button">
              Export
            </button>
            <button id="demoBtn" class="btn small secondary" type="button">
              Demo data
            </button>
          </div>
        </div>

        <form id="classmateForm">
          <input type="hidden" id="editIndex" />

          <div>
            <label for="name">Full name *</label>
            <input id="name" type="text" required placeholder="e.g. Aisha Mwangi" />
          </div>

          <div class="field-row" style="margin-top:0.55rem;">
            <div>
              <label for="phone">Phone number *</label>
              <input id="phone" type="tel" required placeholder="e.g. 07xx xxx xxx" />
            </div>
            <div>
              <label for="town">Town *</label>
              <select id="town" required></select>
            </div>
          </div>

          <!-- Custom town input -->
          <div style="margin-top:0.45rem;">
            <label for="customTown">Town missing? Add it here:</label>
            <div style="display:flex; gap:0.4rem;">
              <input id="customTown" type="text" placeholder="Type town name..." />
              <button type="button" class="btn small secondary" id="addTownBtn">Add town</button>
            </div>
          </div>

          <div style="margin-top:0.55rem;">
            <label for="place">Specific place in town</label>
            <input id="place" type="text" placeholder="Estate, school, street..." />
          </div>

          <div class="field-row" style="margin-top:0.55rem;">
            <div>
              <label for="lat">Latitude (optional)</label>
              <input id="lat" type="text" placeholder="-1.286389" />
            </div>
            <div>
              <label for="lng">Longitude (optional)</label>
              <input id="lng" type="text" placeholder="36.817223" />
            </div>
          </div>

          <div style="margin-top:0.55rem;">
            <label for="notes">Notes (optional)</label>
            <textarea id="notes" placeholder="Anything extra ‚Äì uni, job, etc."></textarea>
          </div>

          <div style="margin-top:0.9rem; display:flex; gap:0.5rem; flex-wrap:wrap;">
            <button type="submit" class="btn" id="saveBtn">Save classmate</button>
            <button type="button" class="btn secondary" id="cancelEditBtn" style="display:none;">
              Cancel edit
            </button>
          </div>
        </form>

        <div style="margin-top:1rem;">
          <div class="controls-top">
            <div class="search">
              <input type="text" id="searchInput" placeholder="Search by name, town, phone..." />
            </div>
            <div class="badge" id="summaryBadge">0 classmates stored</div>
          </div>

          <div id="classmateList" class="list"></div>
          <div id="emptyList" class="empty" style="display:none;">
            No classmates yet. Add a few above or load demo data.
          </div>
        </div>
      </section>

      <!-- RIGHT: "map" of towns -->
      <section class="card">
        <div class="card-header">
          <div>
            <div class="card-title">Kenya town map</div>
            <div class="card-sub">
              Green = classmates in a town. Yellow = classmates in that town who have someone within 5 km.
            </div>
          </div>
          <div class="badge">
            Click a town to see names &amp; phones.
          </div>
        </div>

        <div class="map-header">
          <div class="map-status" id="mapStatus">
            No town selected. Yellow marks classmates that are near another classmate (‚â§5 km).
          </div>
          <div>
            <span class="danger-link" id="clearAllBtn">Clear all saved data</span>
          </div>
        </div>

        <div id="mapGrid" class="map-grid"></div>

        <div class="footer-note">
          Data is stored only in <strong>your browser</strong> (localStorage).  
          Use <strong>Export</strong> to download a backup file, and <strong>Import</strong> to load it later.  
          Proximity is calculated between classmates that have latitude and longitude.
        </div>
      </section>
    </div>

    <!-- ABOUT SECTION -->
    <section class="card" style="margin-top:1.5rem;">
      <div class="card-header">
        <div>
          <div class="card-title">About KinKonnect</div>
          <div class="card-sub">A simple ‚Äúwhere are they now?‚Äù map for a graduating class.</div>
        </div>
      </div>
      <div style="font-size:0.88rem; color:#e5e7eb; line-height:1.5;">
        <p>
          KinKonnect is a small web app built to help a high school class of about 100 students
          stay connected after graduation. Instead of losing touch, classmates can be added with:
        </p>
        <ul class="about-list">
          <li><strong>Basic info</strong> ‚Äì name, phone number, town, and a specific place (estate, school, street).</li>
          <li><strong>Location on a map</strong> ‚Äì optional latitude and longitude for more accurate proximity checks.</li>
          <li><strong>Notes</strong> ‚Äì for things like university, work, or other details.</li>
        </ul>

        <p>
          On the right, towns across Kenya are shown as tiles. A town turns
          <span style="color:#22c55e;">green</span> when there is at least one classmate there.
          A town gets a warm <span style="color:#facc15;">yellow glow</span> when classmates in that town
          have at least one other classmate within <strong>5 km</strong> of them (based on their coordinates).
        </p>

        <p>
          The app also calculates, for each classmate with coordinates, how close they are to their nearest classmate.
          If their nearest neighbour is within 5 km, their card is highlighted in yellow and shows a
          ‚ÄúNearest classmate: X km away‚Äù label. This makes it easy to see who could realistically meet up in person.
        </p>

        <p>
          KinKonnect runs entirely in the browser using HTML, CSS and JavaScript. All data is stored locally using
          <code>localStorage</code>, and can be backed up or restored using the Export and Import buttons. No external
          server or database is required ‚Äì it can be hosted as a static site (for example on GitHub Pages).
        </p>

        <p>
          The town list starts with common towns in Kenya, but anyone can type a missing town name and add it to
          the map. This keeps the app flexible for smaller or less well-known places.
        </p>

        <p class="small-muted">
          KinKonnect is not a live tracking tool. Locations are only as accurate and as up-to-date as what
          classmates choose to enter. It is designed as a friendly way to visualise where everyone ended up,
          and to make it easier to reconnect when people are in the same area.
        </p>

        <p class="small-muted" style="margin-top:0.5rem;">
          Made by <strong>Kathy Kemunto</strong> and <strong>Sandra Njeri</strong>, Class of 2026.
        </p>
      </div>
    </section>
  </div>

  <script>
    // ---------- CONFIG ----------
    const STORAGE_KEY = "kinkonnect-classmates-v1";
    const TOWNS_KEY = "kinkonnect-towns-v1";
    const THEME_KEY = "kinkonnect-theme-v1";

    const BASE_TOWNS = [
      "Nairobi", "Mombasa", "Kisumu", "Nakuru", "Eldoret", "Thika", "Nyeri",
      "Meru", "Embu", "Kericho", "Naivasha", "Kitale", "Kakamega", "Bungoma",
      "Machakos", "Kajiado", "Narok", "Lamu", "Garissa", "Wajir", "Isiolo",
      "Nanyuki", "Voi", "Malindi", "Kilifi", "Homa Bay", "Migori", "Kisii",
      "Busia", "Siaya", "Marsabit", "Lodwar", "Hola", "Mumias", "Kitui",
      "Makueni", "Murang'a", "Kiambu", "Kerugoya", "Limuru", "Athi River",
      "Ruiru", "Kangemi", "Kawangware", "Karatina", "Bomet", "Litein",
      "Chuka", "Kapsabet"
    ];

    let TOWNS = [];

    function loadClassmates() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return [];
        const parsed = JSON.parse(raw);
        return Array.isArray(parsed) ? parsed : [];
      } catch {
        return [];
      }
    }

    function saveClassmates(list) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
    }

    function loadTowns() {
      try {
        const raw = localStorage.getItem(TOWNS_KEY);
        if (!raw) return [...BASE_TOWNS];
        const parsed = JSON.parse(raw);
        if (!Array.isArray(parsed)) return [...BASE_TOWNS];
        const cleaned = parsed
          .map((t) => (typeof t === "string" ? t.trim() : ""))
          .filter((t) => t.length > 0);
        return cleaned.length ? cleaned : [...BASE_TOWNS];
      } catch {
        return [...BASE_TOWNS];
      }
    }

    function saveTowns(list) {
      localStorage.setItem(TOWNS_KEY, JSON.stringify(list));
    }

    function toTitleCase(s) {
      return s
        .toLowerCase()
        .split(" ")
        .filter((p) => p.length > 0)
        .map((p) => p[0].toUpperCase() + p.slice(1))
        .join(" ");
    }

    function distanceKm(lat1, lon1, lat2, lon2) {
      const R = 6371;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a =
        Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(lat1 * Math.PI / 180) *
          Math.cos(lat2 * Math.PI / 180) *
          Math.sin(dLon / 2) *
          Math.sin(dLon / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    function computeProximity() {
      const n = classmates.length;
      const prox = new Array(n);
      for (let i = 0; i < n; i++) prox[i] = { nearestKm: null };

      for (let i = 0; i < n; i++) {
        const ci = classmates[i];
        if (ci.lat == null || ci.lng == null) continue;
        const lat1 = parseFloat(ci.lat);
        const lng1 = parseFloat(ci.lng);
        if (!Number.isFinite(lat1) || !Number.isFinite(lng1)) continue;

        for (let j = i + 1; j < n; j++) {
          const cj = classmates[j];
          if (cj.lat == null || cj.lng == null) continue;
          const lat2 = parseFloat(cj.lat);
          const lng2 = parseFloat(cj.lng);
          if (!Number.isFinite(lat2) || !Number.isFinite(lng2)) continue;

          const d = distanceKm(lat1, lng1, lat2, lng2);
          if (!Number.isFinite(d)) continue;

          if (prox[i].nearestKm === null || d < prox[i].nearestKm)
            prox[i].nearestKm = d;
          if (prox[j].nearestKm === null || d < prox[j].nearestKm)
            prox[j].nearestKm = d;
        }
      }
      return prox;
    }

    let classmates = loadClassmates();
    let selectedTown = null;

    const townSelect = document.getElementById("town");
    const customTownInput = document.getElementById("customTown");
    const addTownBtn = document.getElementById("addTownBtn");

    const classmateForm = document.getElementById("classmateForm");
    const editIndexInput = document.getElementById("editIndex");
    const nameInput = document.getElementById("name");
    const phoneInput = document.getElementById("phone");
    const placeInput = document.getElementById("place");
    const notesInput = document.getElementById("notes");
    const latInput = document.getElementById("lat");
    const lngInput = document.getElementById("lng");
    const saveBtn = document.getElementById("saveBtn");
    const cancelEditBtn = document.getElementById("cancelEditBtn");

    const searchInput = document.getElementById("searchInput");
    const classmateListEl = document.getElementById("classmateList");
    const emptyListEl = document.getElementById("emptyList");
    const summaryBadge = document.getElementById("summaryBadge");

    const mapGrid = document.getElementById("mapGrid");
    const mapStatus = document.getElementById("mapStatus");
    const clearAllBtn = document.getElementById("clearAllBtn");
    const demoBtn = document.getElementById("demoBtn");

    const importBtn = document.getElementById("importBtn");
    const exportBtn = document.getElementById("exportBtn");
    const importFileInput = document.getElementById("importFile");

    const themeToggleBtn = document.getElementById("themeToggle");
    const bodyEl = document.body;

    function applyTheme(theme) {
      if (theme === "light") {
        bodyEl.classList.add("theme-light");
        themeToggleBtn.textContent = "Dark mode";
      } else {
        bodyEl.classList.remove("theme-light");
        themeToggleBtn.textContent = "Light mode";
      }
      localStorage.setItem(THEME_KEY, theme);
    }

    const savedTheme = localStorage.getItem(THEME_KEY) || "dark";
    applyTheme(savedTheme);

    themeToggleBtn.addEventListener("click", () => {
      const current = bodyEl.classList.contains("theme-light") ? "light" : "dark";
      const next = current === "light" ? "dark" : "light";
      applyTheme(next);
    });

    function initTownsDropdown() {
      townSelect.innerHTML = '<option value="">Select town‚Ä¶</option>';
      const sorted = [...TOWNS].sort((a, b) => a.localeCompare(b));
      sorted.forEach((t) => {
        const opt = document.createElement("option");
        opt.value = t;
        opt.textContent = t;
        townSelect.appendChild(opt);
      });
    }

    addTownBtn.addEventListener("click", () => {
      const raw = customTownInput.value.trim();
      if (!raw) {
        alert("Please type a town name first.");
        return;
      }
      const formatted = toTitleCase(raw);
      if (TOWNS.includes(formatted)) {
        alert("That town is already in the list.");
        townSelect.value = formatted;
        customTownInput.value = "";
        return;
      }
      TOWNS.push(formatted);
      saveTowns(TOWNS);
      initTownsDropdown();
      townSelect.value = formatted;
      customTownInput.value = "";
      renderMap();
      alert(`Added "${formatted}" to the town list.`);
    });

    function renderClassmateList() {
      const term = searchInput.value.trim().toLowerCase();
      const proximity = computeProximity();

      let filtered = classmates;
      if (selectedTown) {
        filtered = filtered.filter((c) => c.town === selectedTown);
      }

      if (term) {
        filtered = filtered.filter((c) => {
          const haystack = [c.name, c.phone, c.town, c.place, c.notes]
            .filter(Boolean)
            .join(" ")
            .toLowerCase();
          return haystack.includes(term);
        });
      }

      classmateListEl.innerHTML = "";
      summaryBadge.textContent =
        classmates.length +
        (classmates.length === 1 ? " classmate stored" : " classmates stored");

      if (filtered.length === 0) {
        emptyListEl.style.display = "block";
        return;
      } else {
        emptyListEl.style.display = "none";
      }

      filtered.forEach((c) => {
        const item = document.createElement("div");
        item.className = "classmate";

        const indexInFull = classmates.indexOf(c);
        const prox = proximity[indexInFull];

        let distanceText = "";

        if (prox && prox.nearestKm !== null) {
          const dRounded = Math.round(prox.nearestKm * 10) / 10;
          distanceText = "Nearest classmate: " + dRounded + " km away";
          if (prox.nearestKm <= 5) {
            item.classList.add("nearby");
          }
        }

        item.innerHTML = `
          <div class="classmate-header">
            <div>
              <div class="classmate-name">${c.name}</div>
              <div class="classmate-town">${c.town || "No town set"}</div>
            </div>
            <div class="classmate-phone">${c.phone}</div>
          </div>
          ${c.place ? `<div class="classmate-detail">üìç ${c.place}</div>` : ""}
          ${distanceText ? `<div class="classmate-detail">üìè ${distanceText}</div>` : ""}
          ${c.notes ? `<div class="classmate-detail">${c.notes}</div>` : ""}
          <div style="margin-top:0.25rem; display:flex; gap:0.5rem; flex-wrap:wrap;">
            <button class="btn small secondary" data-action="edit" data-index="${indexInFull}">Edit</button>
            <button class="btn small secondary" data-action="delete" data-index="${indexInFull}">Delete</button>
          </div>
        `;

        classmateListEl.appendChild(item);
      });
    }

    classmateListEl.addEventListener("click", (e) => {
      const target = e.target;
      if (!(target instanceof HTMLElement)) return;
      const action = target.getAttribute("data-action");
      const indexStr = target.getAttribute("data-index");
      if (!action || indexStr === null) return;
      const index = parseInt(indexStr, 10);
      if (Number.isNaN(index) || index < 0 || index >= classmates.length) return;

      const c = classmates[index];

      if (action === "edit") {
        editIndexInput.value = index;
        nameInput.value = c.name || "";
        phoneInput.value = c.phone || "";
        townSelect.value = c.town || "";
        placeInput.value = c.place || "";
        notesInput.value = c.notes || "";
        latInput.value =
          c.lat !== null && c.lat !== undefined ? String(c.lat) : "";
        lngInput.value =
          c.lng !== null && c.lng !== undefined ? String(c.lng) : "";
        saveBtn.textContent = "Update classmate";
        cancelEditBtn.style.display = "inline-flex";
        nameInput.focus();
      } else if (action === "delete") {
        if (confirm(`Delete ${c.name}?`)) {
          classmates.splice(index, 1);
          saveClassmates(classmates);
          renderClassmateList();
          renderMap();
        }
      }
    });

    function resetForm() {
      classmateForm.reset();
      editIndexInput.value = "";
      saveBtn.textContent = "Save classmate";
      cancelEditBtn.style.display = "none";
    }

    classmateForm.addEventListener("submit", (e) => {
      e.preventDefault();

      const latVal = latInput.value.trim();
      const lngVal = lngInput.value.trim();
      const latNum = parseFloat(latVal);
      const lngNum = parseFloat(lngVal);
      const lat = latVal && Number.isFinite(latNum) ? latNum : null;
      const lng = lngVal && Number.isFinite(lngNum) ? lngNum : null;

      const newC = {
        name: nameInput.value.trim(),
        phone: phoneInput.value.trim(),
        town: townSelect.value,
        place: placeInput.value.trim(),
        notes: notesInput.value.trim(),
        lat,
        lng
      };

      if (!newC.name || !newC.phone || !newC.town) {
        alert("Name, phone and town are required.");
        return;
      }

      const editIndex = editIndexInput.value;
      if (editIndex !== "") {
        const idx = parseInt(editIndex, 10);
        if (!Number.isNaN(idx) && idx >= 0 && idx < classmates.length) {
          classmates[idx] = newC;
        }
      } else {
        classmates.push(newC);
      }

      saveClassmates(classmates);
      resetForm();
      renderClassmateList();
      renderMap();
    });

    cancelEditBtn.addEventListener("click", () => {
      resetForm();
    });

    function renderMap() {
      mapGrid.innerHTML = "";

      const counts = {};
      classmates.forEach((c) => {
        if (!c.town) return;
        counts[c.town] = (counts[c.town] || 0) + 1;
      });

      const proximity = computeProximity();
      const nearbyCounts = {};

      classmates.forEach((c, idx) => {
        if (!c.town) return;
        const info = proximity[idx];
        if (!info || info.nearestKm === null) return;
        if (info.nearestKm <= 5) {
          nearbyCounts[c.town] = (nearbyCounts[c.town] || 0) + 1;
        }
      });

      const sortedTowns = [...TOWNS].sort((a, b) => a.localeCompare(b));

      sortedTowns.forEach((town) => {
        const count = counts[town] || 0;
        const nearbyCount = nearbyCounts[town] || 0;
        const tile = document.createElement("button");
        tile.type = "button";
        tile.className = "town-tile";
        if (count > 0) tile.classList.add("has-people");
        if (nearbyCount > 0) tile.classList.add("nearby-town");
        if (selectedTown === town) tile.classList.add("selected");

        tile.innerHTML = `
          <span class="town-name">${town}</span>
          <span class="town-count">${
            count === 0 ? "No one here (yet)" :
            count === 1 ? "1 classmate here" :
            count + " classmates here"
          }${
            nearbyCount > 0
              ? " ‚Ä¢ " +
                (nearbyCount === 1
                  ? "1 has someone within 5 km"
                  : nearbyCount + " have someone within 5 km")
              : ""
          }</span>
        `;

        tile.addEventListener("click", () => {
          if (selectedTown === town) {
            selectedTown = null;
            mapStatus.textContent =
              "No town selected. Yellow marks classmates that are near another classmate (‚â§5 km).";
          } else {
            selectedTown = town;
            const num = counts[town] || 0;
            mapStatus.textContent =
              num === 0
                ? `No classmates saved in ${town} yet.`
                : `${num} classmate${num === 1 ? "" : "s"} in ${town} ‚Äì listed on the left.`;
          }
          renderClassmateList();
          renderMap();
        });

        mapGrid.appendChild(tile);
      });
    }

    clearAllBtn.addEventListener("click", () => {
      if (
        confirm(
          "This will delete ALL saved classmates from this browser. Custom towns will stay. Continue?"
        )
      ) {
        classmates = [];
        saveClassmates(classmates);
        selectedTown = null;
        mapStatus.textContent =
          "No town selected. Yellow marks classmates that are near another classmate (‚â§5 km).";
        renderClassmateList();
        renderMap();
      }
    });

    searchInput.addEventListener("input", () => {
      renderClassmateList();
    });

    demoBtn.addEventListener("click", () => {
      if (
        classmates.length > 0 &&
        !confirm(
          "Demo data will be added on top of your current list. Continue?"
        )
      ) {
        return;
      }

      const demo = [
        {
          name: "Aisha Mwangi",
          phone: "0712 345 678",
          town: "Nairobi",
          place: "South B ‚Äì Golden Gate",
          notes: "Wants to study medicine at UoN.",
          lat: -1.3000,
          lng: 36.8500
        },
        {
          name: "Brian Otieno",
          phone: "0722 111 222",
          town: "Nairobi",
          place: "Upper Hill",
          notes: "Loves basketball and coding.",
          lat: -1.2950,
          lng: 36.8300
        },
        {
          name: "Grace Wanjiru",
          phone: "0790 555 444",
          town: "Nakuru",
          place: "Shabaab",
          notes: "Gap year then uni.",
          lat: -0.3031,
          lng: 36.0800
        },
        {
          name: "Kevin Kiptoo",
          phone: "0700 000 999",
          town: "Eldoret",
          place: "Kapsoya",
          notes: "Training for athletics.",
          lat: 0.5204,
          lng: 35.2698
        },
        {
          name: "Fatma Ahmed",
          phone: "0733 222 333",
          town: "Mombasa",
          place: "Nyali",
          notes: "Into photography.",
          lat: -4.0435,
          lng: 39.6682
        }
      ];

      classmates = classmates.concat(demo);
      saveClassmates(classmates);
      renderClassmateList();
      renderMap();
    });

    exportBtn.addEventListener("click", () => {
      if (classmates.length === 0) {
        alert("No classmates to export yet.");
        return;
      }
      try {
        const dataStr = JSON.stringify(classmates, null, 2);
        const blob = new Blob([dataStr], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "kinkonnect-classmates.json";
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      } catch (err) {
        alert("Could not export data.");
      }
    });

    importBtn.addEventListener("click", () => {
      importFileInput.click();
    });

    importFileInput.addEventListener("change", () => {
      const file = importFileInput.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (event) => {
        try {
          const text = event.target.result;
          const imported = JSON.parse(text);
          if (!Array.isArray(imported)) {
            alert("Invalid file format. Expected a list of classmates.");
            return;
          }

          if (
            classmates.length > 0 &&
            !confirm(
              "This will REPLACE your current classmates with the imported list. Continue?"
            )
          ) {
            return;
          }

          classmates = imported;
          saveClassmates(classmates);
          selectedTown = null;
          mapStatus.textContent =
            "No town selected. Yellow marks classmates that are near another classmate (‚â§5 km).";
          renderClassmateList();
          renderMap();
          alert("Import successful!");
        } catch (err) {
          alert("Could not read that file. Make sure it's a KinKonnect export.");
        }
      };

      reader.readAsText(file);
      importFileInput.value = "";
    });

    TOWNS = loadTowns();
    initTownsDropdown();
    renderClassmateList();
    renderMap();
  </script>
</body>
</html>
